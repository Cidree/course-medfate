---
title: "Exercise 2b solution"
author: "Miquel De Cáceres"
date: '2024-11-07'
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Exercise setting

## Overall goal

Learn how sub-model of bulk soil water movement influences water balance results.

## Exercise material

+ Exercise_2b.Rmd
+ fontblanche.rds

## Font-Blanche research forest

 + The Font-Blanche research forest is located in southeastern France (43º14'27'' N 5°40'45'' E) at 420 m elevation)
 + The stand is composed of a top strata of *Pinus halepensis* (Aleppo pine) reaching about 12 m, a lower strata of *Quercus ilex* (holm oak), reaching about 6 m, and an understorey strata dominated by *Quercus coccifera* and *Phillyrea latifolia*. 
 + Soils are shallow and rocky, have a low retention capacity and are of Jurassic limestone origin. 
 + The climate is Mediterranean, with a water stress period in summer, cold or mild winters and most precipitation occurring between September and May. 

## Target stand

+ The experimental site, which is dedicated to study forest carbon and water cycles, has an enclosed area of 80×80 m but our target stand is a quadrat of dimensions 25×25 m. 
+ The following observations are available for year 2014:
   + Soil moisture content of the topmost (0-30 cm) layer.

# Exercise solution

## Step 1. Load Font-Blanche data

```{r, include=FALSE}
library(medfate)
library(ggplot2)
library(cowplot)
```

We are given all the necessary data, bundled in a single list:

```{r}
fb <- readRDS("exercises/StudentRdata/fontblanche.rds")
```

## Step 2. Build forest object

Element `fb$treeData` is already in the appropriate format for `forest` objects. Therefore, we can easily plug the tree data into a forest object:

```{r}
fb_forest <- emptyforest() 
fb_forest$treeData <- fb$treeData
```

## Step 3. Initialize soil object

A data frame with soil physical attributes are defined in `fb$soilData` but initialize a `soil` object to complete the hydraulic parameters:

```{r}
fb_soil <- soil(fb$soilData)
```

From which we can estimate the water holding capacity and extractable (down to -5 MPa) water capacity for each layer (in mm) using functions `soil_waterFC()` and `soil_waterExtractable()`:

```{r}
soil_waterFC(fb_soil)
soil_waterExtractable(fb_soil)
```

So the sums would be:
```{r}
sum(soil_waterFC(fb_soil))
sum(soil_waterExtractable(fb_soil))
```

The same information can also be found in the output of `summary()`.

```{r}
summary(fb_soil)
```

## Step 4. Species parameters

In the case of FontBlanche there is a table of preferred values for some parameters:

```{r}
fb$customParams
```

We can use function `modifySpParams()` to replace the values of parameters for the desired traits, leaving the rest unaltered:

```{r}
fb_SpParams <- modifySpParams(SpParamsMED, fb$customParams)
```

## Step 5. Initialize water balance inputs under different sub-models of vertical soil water fluxes

Since we are about to run a basic water balance simulation, we initialize `spwbInput` while using `transpirationMode = "Granier"` in the control parameters. However, in this case we also specify the option `soilDomains`, for which we have three different alternatives:

```{r}
x_buckets <- spwbInput(fb_forest, fb_soil, fb_SpParams, 
                       control = defaultControl(transpirationMode = "Granier", soilDomains = "buckets"))
x_single <- spwbInput(fb_forest, fb_soil, fb_SpParams, 
                      control = defaultControl(transpirationMode = "Granier", soilDomains = "single"))
x_dual <- spwbInput(fb_forest, fb_soil, fb_SpParams, 
                    control = defaultControl(transpirationMode = "Granier", soilDomains = "dual"))
```

## Step 6. Run water balance model while assessing computation times

Computation time can be limiting in some cases. Here we can insert the simulation within a block inside a call to `system.time()`, to estimate computation time:

```{r, eval=TRUE}
system.time({fb_buckets <- spwb(x_buckets, fb_meteo, elevation = 420, latitude = 43.24)})
system.time({fb_single <- spwb(x_single, fb_meteo, elevation = 420, latitude = 43.24)})
system.time({fb_dual <- spwb(x_dual, fb_meteo, elevation = 420, latitude = 43.24)})
```

**Interpretation**: The bucket model is the fastest, followed by the single domain. The dual domain sub-model is the slowest of all three. These differences in computation time arise from the need to solve soil fluxes at fine temporal steps.

## Step 7. Compare water balance components

We can use the `summary()` function for `spwb` objects to see the annual-level values of water balance components. Since only one year is simulated, we bind the three vectors corresponding to the different sub-models as rows:

```{r}
m <- rbind(summary(fb_buckets),
           summary(fb_single),
           summary(fb_dual))
rownames(m) <- c("buckets", "single", "dual")
m
```

**Interpretation**: Rainfall inputs and intercepted water are equal regardless of the sub-model for soil fluxes. The buckets model

## Step 8. Compare runoff and deep drainage temporal patterns

Surface run-off occurs the same day as precipitation events, whereas deep drainage can last for some days after the event: 
```{r echo=TRUE, fig.height=9, fig.width=9, fig=TRUE}
g1<-plot(fb_basic_buckets)+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  theme(legend.position = "none")
g2<-plot(fb_basic_buckets, "Export")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,60))+
  labs(title="buckets")+
  theme(legend.position = "inside", legend.position.inside = c(0.35,0.60))
g3<-plot(fb_basic_single, "Export")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,60))+
  labs(title="single")+
  theme(legend.position = "none")
g4<-plot(fb_basic_dual, "Export")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,60))+
  labs(title="dual")+
  theme(legend.position = "none")
plot_grid(g1,g2, g3, g4, ncol=1, rel_heights = c(0.5,1,1,1))
```


```{r echo=TRUE, fig.height=9, fig.width=9, fig=TRUE}
g1<-plot(fb_basic_buckets, summary.freq = "months")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  theme(legend.position = "none")
g2<-plot(fb_basic_buckets, "Export", summary.freq = "months")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,200))+
  labs(title="buckets")+
  theme(legend.position = "inside", legend.position.inside = c(0.35,0.60))
g3<-plot(fb_basic_single, "Export", summary.freq = "months")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,200))+
  labs(title="single")+
  theme(legend.position = "none")
g4<-plot(fb_basic_dual, "Export", summary.freq = "months")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,200))+
  labs(title="dual")+
  theme(legend.position = "none")
plot_grid(g1,g2, g3, g4, ncol=1, rel_heights = c(0.5,1,1,1))
```
## Step 8. Examine evapotranspiration flows

Precipitation events also generate flows of intercepted water the same day of the event. Evaporation from the bare soil can proceed some days after the event. Transpiration flow is the dominant one in most days, decreasing in summer due to drought.

```{r fig=TRUE, fig.width=9, fig.height = 9}
g1<-plot(fb_basic_buckets)+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  theme(legend.position = "none")
g2<-plot(fb_basic_buckets, "Evapotranspiration")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,4))+
  labs(title="buckets")+
  theme(legend.position = "inside", legend.position.inside = c(0.14,0.73))
g3<-plot(fb_basic_single, "Evapotranspiration")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,4))+
  labs(title="single")+
  theme(legend.position = "none")
g4<-plot(fb_basic_dual, "Evapotranspiration")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  scale_y_continuous(limits = c(0,4))+
  labs(title="dual")+
  theme(legend.position = "none")
plot_grid(g1,g2, g3, g4, ncol=1, rel_heights = c(0.5,1,1,1))
```

## Step 9. Soil water potential dynamics

We can display the dynamics of water potential in different soil layers using:

```{r fig=TRUE, fig.width=9, fig.height = 9}
g1<-plot(fb_basic_buckets)+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+
  theme(legend.position = "none")
g2<-plot(fb_basic_buckets, "SoilPsi")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+ 
  scale_y_continuous("Soil WP (MPa)", lim=c(-4,0))+
  labs(title="buckets")+
  theme(legend.position = "inside", legend.position.inside = c(0.14,0.73))
g3<-plot(fb_basic_single, "SoilPsi")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+ 
  scale_y_continuous("Soil WP (MPa)", lim=c(-4,0))+
  labs(title="single")+
  theme(legend.position = "none")
g4<-plot(fb_basic_dual, "SoilPsi")+
  scale_x_date(date_breaks = "1 month", date_labels = "%m")+ 
  scale_y_continuous("Soil WP (MPa)", lim=c(-4,0))+
  labs(title="dual")+
  theme(legend.position = "none")
plot_grid(g1,g2, g3, g4, 
          ncol=1, rel_heights = c(0.5,1,1,1))
```

**Tip**: Normally, we should expect lower layers to have a less dynamic behaviour, but strange results can occur if, for instance, a large proportion of roots is in deeper layers.


```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=8}
fb_observed <- fb$measuredData
g1 <- evaluation_plot(fb_basic_buckets, fb_observed, type = "SWC", plotType="dynamics")+
  labs(title="buckets")
g2 <- evaluation_plot(fb_basic_single, fb_observed, type = "SWC", plotType="dynamics")+
  labs(title="single")
g3 <- evaluation_plot(fb_basic_dual, fb_observed, type = "SWC", plotType="dynamics")+
  labs(title="dual")
plot_grid(g1,g2, g3, ncol = 1)
```

```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=8}
g1 <- evaluation_plot(fb_basic_buckets, fb_observed, type = "SWC", plotType="scatter")+
  labs(title="buckets")
g2 <- evaluation_plot(fb_basic_single, fb_observed, type = "SWC", plotType="scatter")+
  labs(title="single")
g3 <- evaluation_plot(fb_basic_dual, fb_observed, type = "SWC", plotType="scatter")+
  labs(title="dual")
plot_grid(g1,g2, g3, ncol = 2)
```

```{r}
evaluation_stats(fb_basic_buckets, fb_observed, typ="SWC")
evaluation_stats(fb_basic_single, fb_observed, typ="SWC")
evaluation_stats(fb_basic_dual, fb_observed, typ="SWC")
```

