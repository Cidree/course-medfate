---
title: "III.b - Forest water and energy balances"
author: "Miquel De CÃ¡ceres (EMF)"
date: "24/2/2022"
output: 
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
---

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(medfate)
```

layout: true
### Water balance inputs

---

#### Creating the water balance input object

We assume we have an appropriate forest object and species parameter data frame:
```{r, echo = TRUE}
data(exampleforestMED)
data(SpParamsMED)
```

--

a soil input object:
```{r, echo = TRUE}
examplesoil <- soil(defaultSoilParams(4))
```

--
and simulation control list:
```{r, echo = TRUE}
control <- defaultControl("Granier")
```

--

With these four elements we can build our input object for function `spwb()`:
```{r, echo = TRUE}
x <- forest2spwbInput(exampleforestMED, examplesoil, SpParamsMED, control)
```

---
#### Structure of the water balance input object

The water balance input object is a `list` with several elements:
```{r, echo = TRUE}
names(x)
```

--

Elements `soil` and `control` contain copies of the parameters used in the call to `forest2spwbInput()`.

--

Element `cohorts` contains the species identity of each cohort:
```{r, echo = TRUE}
x$cohorts
```

---

#### Structure of the water balance input object

Element `above` contains above-ground description of vegetation:
```{r, echo = TRUE}
x$above
```

--

Element `below` contains below-ground description of vegetation:
```{r, echo = TRUE}
x$below
```

---
#### Structure of the water balance input object

Elements `params*` contain cohort-level parameters, for example:
```{r, echo = TRUE}
x$paramsTranspiration
```

--

Elements `internal*` contain cohort-level state variables, for example:
```{r, echo = TRUE}
x$internalPhenology
```

---
#### Weather data frame

Finally, we need a weather data frame:
```{r, echo = TRUE}
data(examplemeteo)
```

Now we are ready to use function `spwb()` !
---
layout: true
### Using the basic water balance model

---
#### Water balance run

The call to function `spwb()` needs the water balance input object, the weather data frame, latitude and elevation:

```{r, echo = TRUE, eval = FALSE}
S <- spwb(x, examplemeteo, latitude = 41.82592, elevation = 100)
```
```{r, include = FALSE, eval = TRUE}
S <- spwb(x, examplemeteo, latitude = 41.82592, elevation = 100)
```

--

Function `spwb()` returns an object of class with the same name, actually a list:
```{r, echo = TRUE}
class(S)
```

--
It is interesting to inspect the list element names:
```{r, echo = TRUE}
names(S)
```

---
#### Summaries

The package provides a `summary()` function for objects of class `spwb`. It can be used to extract/summarize the model's output at different temporal steps (i.e. weekly, annual, ...).

For example, to obtain the average soil moisture and water potentials by months one can use:
```{r, echo = TRUE, eval = FALSE}
summary(S, freq="months",FUN=mean, output="Soil")
```

--

Parameter `output` indicates the element of the `spwb` object for which we desire a summary. Similarly, it is possible to calculate the average stress of plant cohorts by months:

```{r, echo = TRUE, eval = FALSE}
summary(S, freq="months",FUN=mean, output="PlantStress")
```

--

The `summary` function can be also used to aggregate the output by species. In this case, the values of plant cohorts belonging to the same species will be averaged using LAI values as weights:
```{r, echo = TRUE, eval = FALSE}
summary(S, freq="months", output="PlantStress", bySpecies = TRUE)
```

---
#### Plots 

The package provides a `plot()` function for objects of class `spwb`. It can be used to show weather inputs and different components of the water balance, for example:

```{r, echo = TRUE, fig=TRUE, fig.align="center", fig.width=6, fig.height = 4}
plot(S, type = "PET_Precipitation")
```

--

The help page of `?plot.spwb` lists all the possible plots...

---
#### Interactive plots

... but instead of typing all plots, we can call the interactive plot function and explore them all:

```{r, eval = FALSE, include = TRUE, echo = TRUE}
shinyplot(S)
```

---
#### Post-processing functions

The package provides some functions to extract or transform specific outputs from soil plant water balance simulations. 

--

Function `droughtStress()` allows calculating several plant stress indices, such as the maximum drought stress value per month:
```{r, echo = TRUE}
DS <- droughtStress(S, index = "MDS", freq = "months", draw=FALSE)
head(DS)
```

--

Other similar post-processing functions are `waterUseEfficiency()` or `fireHazard()`.

---
layout: true
### Advanced water balance model

---
#### Creating an input object for the advanced model
The most important step to run the advanced model is to specify the appropriate transpiration mode in the `control` parameters:
```{r, echo = TRUE}
control <- defaultControl("Sperry")
```
We can build our input object for function `spwb()` using the same function as before:
```{r, echo = TRUE}
x_adv <- forest2spwbInput(exampleforestMED, examplesoil, SpParamsMED, control)
```
The water balance input object contains some new elements:
```{r, echo = TRUE}
names(x_adv)
```

---
#### Creating an input object for the advanced model
... but the main difference with the basic model is in the number of parameters, e.g.:
```{r, echo = TRUE}
x_adv$paramsTranspiration
```

---
#### Static analysis of plant hydraulics
#### Water/energy balance run for a single day
#### Water/energy balance run for a multiple days
#### Summaries, plots and interactive plots

---
layout: true
### Evaluating model performance


---
layout: true
### Modifying model inputs

