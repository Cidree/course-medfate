---
title: "III.b - Forest water and energy balances"
author: "Miquel De CÃ¡ceres (EMF)"
date: "`r Sys.Date()`"
output: 
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
---

```{r setup, include=FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE)
```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#1381B0",
  secondary_color = "#FF961C",
  inverse_header_color = "#FFFFFF"
)
```

```{r, include = FALSE}
library(medfate)
library(cowplot)
```

background-image: url(isotip-fons.png)

### Outline

  1. Water balance inputs
  2. Basic water balance
  3. Advanced water/energy balance
  4. Evaluating model performance
  5. Modifying model inputs


---
layout: true
### 1. Water balance inputs

---

#### Creating the water balance input object

We assume we have an appropriate forest object and species parameter data frame:
```{r, echo = TRUE}
data(exampleforestMED)
data(SpParamsMED)
```

--

a soil input object:
```{r, echo = TRUE}
examplesoil <- soil(defaultSoilParams(4))
```

--
and simulation control list:
```{r, echo = TRUE}
control <- defaultControl("Granier")
```

--

With these four elements we can build our input object for function `spwb()`:
```{r, echo = TRUE}
x <- forest2spwbInput(exampleforestMED, examplesoil, SpParamsMED, control)
```

---
#### Structure of the water balance input object

The water balance input object is a `list` with several elements:
```{r, echo = TRUE}
names(x)
```

--

Elements `soil` and `control` contain copies of the parameters used in the call to `forest2spwbInput()`.

--

Element `cohorts` contains the species identity of each cohort:
```{r, echo = TRUE}
x$cohorts
```

---

#### Structure of the water balance input object

Element `above` contains above-ground description of vegetation:
```{r, echo = TRUE}
x$above
```

--

Element `below` contains below-ground description of vegetation:
```{r, echo = TRUE}
x$below
```

---
#### Structure of the water balance input object

Elements `params*` contain cohort-level parameters, for example:
```{r, echo = TRUE}
x$paramsTranspiration
```

--

Elements `internal*` contain cohort-level state variables, for example:
```{r, echo = TRUE}
x$internalPhenology
```

---
#### Weather data frame

Finally, we need a weather data frame:
```{r, echo = TRUE}
data(examplemeteo)
```

Now we are ready to use function `spwb()` !

---
layout: true
### 2. Basic water balance

---
#### Water balance run

The call to function `spwb()` needs the water balance input object, the weather data frame, latitude and elevation:

```{r, echo = TRUE, eval = FALSE}
S <- spwb(x, examplemeteo, latitude = 41.82592, elevation = 100)
```
```{r, include = FALSE, eval = TRUE}
S <- spwb(x, examplemeteo, latitude = 41.82592, elevation = 100)
```

--

Function `spwb()` returns an object of class with the same name, actually a list:
```{r, echo = TRUE}
class(S)
```

--
It is interesting to inspect the list element names:
```{r, echo = TRUE}
names(S)
```

---
#### Summaries

The package provides a `summary()` function for objects of class `spwb`. It can be used to extract/summarize the model's output at different temporal steps (i.e. weekly, annual, ...).

For example, to obtain the average soil moisture and water potentials by months one can use:
```{r, echo = TRUE, eval = FALSE}
summary(S, freq="months",FUN=mean, output="Soil")
```

--

Parameter `output` indicates the element of the `spwb` object for which we desire a summary. Similarly, it is possible to calculate the average stress of plant cohorts by months:

```{r, echo = TRUE, eval = FALSE}
summary(S, freq="months",FUN=mean, output="PlantStress")
```

--

The `summary` function can be also used to aggregate the output by species. In this case, the values of plant cohorts belonging to the same species will be averaged using LAI values as weights:
```{r, echo = TRUE, eval = FALSE}
summary(S, freq="months", output="PlantStress", bySpecies = TRUE)
```

---
#### Plots 

The package provides a `plot()` function for objects of class `spwb`. It can be used to show weather inputs and different components of the water balance, for example:

```{r, echo = TRUE, fig=TRUE, fig.align="center", fig.width=6, fig.height = 4}
plot(S, type = "PET_Precipitation")
```

--

The help page of `?plot.spwb` lists all the possible plots...

---
#### Interactive plots

... but instead of typing all plots, we can call the interactive plot function and explore them all:

```{r, eval = FALSE, include = TRUE, echo = TRUE}
shinyplot(S)
```

---
#### Post-processing functions

The package provides some functions to extract or transform specific outputs from soil plant water balance simulations. 

--

Function `droughtStress()` allows calculating several plant stress indices, such as the maximum drought stress value per month:
```{r, echo = TRUE}
DS <- droughtStress(S, index = "MDS", freq = "months", draw=FALSE)
head(DS)
```

--

Other similar post-processing functions are `waterUseEfficiency()` or `fireHazard()`.

---
layout: true
### 3. Advanced water/energy balance

---
#### Creating an input object for the advanced model
The most important step to run the advanced model is to specify the appropriate transpiration mode in the `control` parameters:
```{r, echo = TRUE}
control <- defaultControl("Sperry")
```
We can build our input object for function `spwb()` using the same function as before:
```{r, echo = TRUE}
x_adv <- forest2spwbInput(exampleforestMED, examplesoil, SpParamsMED, control)
```
The water balance input object contains some new elements:
```{r, echo = TRUE}
names(x_adv)
```

---
#### Creating an input object for the advanced model
... but the main difference with the basic model is in the number of parameters, e.g.:
```{r, echo = TRUE}
x_adv$paramsTranspiration
```

---
#### Vulnerability curves

We can inspect *hydraulic vulnerability curves* (i.e. how hydraulic conductance of a given segment changes with the water potential) for each plant cohort and each of the different segments of the soil-plant hydraulic network:

```{r, fig=TRUE, fig.align="center", fig.width=6, fig.height = 3.5, echo = TRUE}
hydraulics_vulnerabilityCurvePlot(x_adv, type="stem", speciesNames = TRUE)
```

The maximum values and shape of vulnerability curves for leaves and stems are regulated by parameters in `paramsTranspiration`.

---
#### Supply functions

The vulnerability curves conforming the hydraulic network are used in the model to build the **supply function**, which relates water flow (i.e. transpiration) with the drop of water potential along the whole hydraulic pathway. 

```{r, fig=TRUE, fig.align="center", fig.width=6, fig.height = 3.5, echo = TRUE}
hydraulics_supplyFunctionPlot(x_adv, examplesoil, type="E", speciesNames = TRUE)
```

---
#### Stomatal regulation

Stomatal conductance is determined after building a photosynthesis function corresponding to the supply function and finding the value of stomatal conductance that maximizes carbon revenue while avoiding hydraulic damage: the *profit-maximization* approach. 

```{r, fig=TRUE, fig.align="center", fig.width=8, fig.height = 4, echo = TRUE}
transp_stomatalRegulationPlot(x_adv, examplemeteo, day = 100, timestep=12,
                              latitude = 41.82592, elevation = 100, type="E")
```

---
#### Pressure-volume curves

```{r, fig=TRUE, fig.align="center", fig.width=5, fig.height = 3.5}
moisture_pressureVolumeCurvePlot(x_adv, segment="leaf", fraction="symplastic")
```

---
#### Water/energy balance run for a single day

Since the model operates at a daily and sub-daily temporal scales, it is possible to perform soil water balance for one day only, by using function `spwb_day()`:
```{r, echo = TRUE}
d = 100
sd1<-spwb_day(x_adv, rownames(examplemeteo)[d],  
             examplemeteo$MinTemperature[d], examplemeteo$MaxTemperature[d], 
             examplemeteo$MinRelativeHumidity[d], examplemeteo$MaxRelativeHumidity[d], 
             examplemeteo$Radiation[d], examplemeteo$WindSpeed[d], 
             latitude = 41.82592, elevation = 100, 
             slope= 0, aspect = 0, prec = examplemeteo$Precipitation[d])
```
The output of `spwb_day()` is a list with several elements:
```{r, echo = TRUE}
names(sd1)
```

---
#### Plotting single-day results

.pull-left[
```{r, fig=TRUE, fig.align="center", fig.width=7, fig.height = 4}
plot(sd1, type = "LeafTranspiration", bySpecies = TRUE)
```
]
.pull-right[
```{r, fig=TRUE, fig.align="center", fig.width=7, fig.height = 4}
plot(sd1, type = "LeafGrossPhotosynthesis", bySpecies = TRUE)
```
]

More conveniently, you can examine multiple plots interactively:
```{r, eval=FALSE, echo=TRUE}
shinyplot(sd1)
```

---
#### Resetting the input object

However, running `spwb_day()` modified the input object. In particular, the soil moisture at the end of the simulation was:
```{r, echo = TRUE}
x_adv$soil$W
```

We simply use function `resetInputs()` to reset state variables to their default values, so that the new simulation is not affected by the end state of the previous simulation:
```{r, echo = TRUE}
resetInputs(x_adv)
x_adv$soil$W
```

---
#### Water/energy balance run for multiple days

We can now run the advanced water balance model (which takes 1 min aprox.)

```{r, eval = FALSE, echo = TRUE}
S_adv <- spwb(x_adv, examplemeteo, latitude = 41.82592, elevation = 100)
```

```{r, echo = FALSE}
S_adv <- readRDS("Rdata/IIIb_spwb_adv.rds")
```

--

Function `spwb()` returns a list of class `spwb`, like the basic water balance model, but which contains more information:
```{r}
names(S_adv)
```

---
#### Summaries, plots and interactive plots
Summaries and plots can be obtained from simulation results, using functions `summary()`:

```{r, echo = TRUE, eval = FALSE}
summary(S_adv, freq="months", output="PlantStress", bySpecies = TRUE)
```

--
and `plot()`:
```{r, echo = TRUE, eval = FALSE}
plot(S_adv, type="LeafPsiMin", bySpecies = TRUE)
```

--

Alternatively, one can interactively create plots using function `shinyplot()`, e.g.:
```{r, eval = FALSE, echo = TRUE}
shinyplot(S_adv)
```


---

layout: true
### 4. Evaluating model performance

---

#### Evaluation metrics
The package provides functions to compare predictions with observations (use `?evaluation` for details on how observations should be arranged).

--

For example, a single evaluation metric can be calculated:
```{r, echo = TRUE}
evaluation_metric(S_adv, exampleobs, type = "SWC", metric = "MAE")
```

--

or many of them:
```{r, echo = TRUE}
evaluation_stats(S_adv, exampleobs, type = "SWC")
```

---

#### Evaluation plots and interactive evaluation

Evaluation functions also allow visualizing the comparison as time series or scatter plots:
```{r, echo = TRUE, fig=TRUE, fig.align="center", fig.width=8, fig.height = 4}
evaluation_plot(S_adv, exampleobs, type = "SWC", plotType = "dynamics")
```

Alternatively, the observed data can be supplied as an additional parameter to `shinyplot()` for interactive graphics including model evaluation:
```{r, echo = TRUE, eval = FALSE}
shinyplot(S_adv, exampleobs)
```


---
layout: false
### 5. Modifying model inputs

Let's imagine one is not happy with a particular cohort parameter. For example, LAI estimates produced by `forest2spwbInput()` do not match known values:
```{r, echo = TRUE}
x_adv$above
```

--

We should not manually modify `x_adv` because some parameters are related and we may break their relationship.

--

Instead, we should use function `modifyInputParams()`:

```{r, echo = TRUE}
x_mod <- modifyInputParams(x_adv, c("T2_168/LAI_live" = 1.1))
```

which will display messages describing the parameters that are modified.


---
class: center, middle

# Thanks!

Slides created via the R packages:

[**xaringan**](https://github.com/yihui/xaringan)<br>
[gadenbuie/xaringanthemer](https://github.com/gadenbuie/xaringanthemer)

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr), and [R Markdown](https://rmarkdown.rstudio.com).
