---
title: "3.3 - Forest growth and dynamics balance (exercise)"
author: "Miquel De Cáceres"
institute: "Ecosystem Modelling Facility, CREAF"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["resources/css/custom.css", "default-fonts", "default"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    seal: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, warning=FALSE}
options(
  htmltools.dir.version = FALSE,
  width = 100
)
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(meteoland)
library(medfate)
library(sp)
```

class: title-slide


# 3.3 - Forest growth/dynamics (exercise)

## Miquel De Cáceres

### Ecosystem Modelling Facility

### `r as.Date("2022-06-15")`


<img class= "escher-title" src="resources/img/Escher_concaveconvex.jpg" width=450>

<img class="logo-title" src="resources/img/emf_logo.svg" width=200>

---
layout: true

<div class=my-header>
    <img class="emf-logo" src="resources/img/emf_logo.svg">
</div>

<div class=my-footer></div>

# Exercise setting

---
## Overall goal

--

## Specific objectives


---
layout: true

<div class=my-header>
    <img class="emf-logo" src="resources/img/emf_logo.svg">
</div>

<div class=my-footer></div>

# Exercise resolution


---
## Step 1. Load Alepo pine forest data

```{r, include=FALSE}
library(medfate)
library(ggplot2)
library(cowplot)
```

We are given all the necessary data, bundled in a single list:

.code80[
```{r}
alepo <- readRDS("StudentRdata/alepo.rds")
names(alepo)
```
]

---

## Step 2. Forest stand metrics

.code80[
```{r, highlight.output = c(2,5)}
summary(alepo$forest_snfi3, SpParamsMED)
```
]

.code80[
```{r}
species_basalArea(alepo$forest_snfi3, SpParamsMED)
```
]

.code80[
```{r}
species_LAI(alepo$forest_snfi3, SpParamsMED)
```
]

---

## Step 3. Growth simulation between SNFI3 and SNFI4

.code80[
```{r}
alepo$soil <- soil(alepo$soildesc)
```
]

.code80[
```{r}
x_alepo <- forest2growthInput(x = alepo$forest_snfi3,
                              soil = alepo$soil,
                              SpParams = SpParamsMED,
                              control = defaultControl())
```
]

.code80[
```{r}
alepo$soil <- soil(alepo$soildesc)
```
]

---

## Step 3. Growth simulation between SNFI3 and SNFI4 
.code80[
```{r, eval = FALSE}
G_34 <- growth(x = x_alepo, 
               meteo = alepo$historic_weather,
               latitude = 41, 
               elevation = alepo$spt$elevation,
               slope = alepo$spt$slope,
               aspect = alepo$spt$aspect)
```
]

---

## Step 4. Examine growth results


---

## Step 5. Evaluate tree basal area increment

```{r, include = FALSE}
# saveRDS(G_34, "Rdata/growth_snfi34.rds")
G_34 <- readRDS("Rdata/growth_snfi34.rds")
```

.code80[
```{r, fig=TRUE, fig.width=10, fig.height=5}
g1<-evaluation_plot(G_34, alepo$observed_growth, type="BAI",
                    cohort = "T20_148", temporalResolution = "year")
g2<-evaluation_plot(G_34, alepo$observed_growth, type="BAI",
                 cohort = "T14_148", temporalResolution = "year")
g3<-evaluation_plot(G_34, alepo$observed_growth, type="BAI",
                 cohort = "T25_148", temporalResolution = "year")
g4<-evaluation_plot(G_34, alepo$observed_growth, type="BAI",
                 cohort = "T3_148", temporalResolution = "year")
plot_grid(g1,g2,g3,g4, ncol = 2, nrow=2)
```
]

---

## Step 6. Modify maximum growth rate for P. halepensis and repeat simulations

We divide the maximum growth rate by two:
```{r}
SpParamsMED$RGRcambiummax[SpParamsMED$Name=="Pinus halepensis"] = 0.0012
```

.code80[
```{r}
x_alepo <- forest2growthInput(x = alepo$forest_snfi3,
                              soil = alepo$soil,
                              SpParams = SpParamsMED,
                              control = defaultControl())
```
]


.code80[
```{r, eval = FALSE}
G_34m <- growth(x = x_alepo, 
               meteo = alepo$historic_weather,
               latitude = 41, 
               elevation = alepo$spt$elevation,
               slope = alepo$spt$slope,
               aspect = alepo$spt$aspect)
```
]


```{r, include = FALSE}
# saveRDS(G_34m, "Rdata/growth_mod_snfi34.rds")
G_34m <- readRDS("Rdata/growth_mod_snfi34.rds")
```

---

## Step 6. Modify maximum growth rate for P. halepensis and repeat simulations

.code80[
```{r, fig=TRUE, fig.width=10, fig.height=5, echo = FALSE}
g1<-evaluation_plot(G_34m, alepo$observed_growth, type="BAI",
                    cohort = "T20_148", temporalResolution = "year")
g2<-evaluation_plot(G_34m, alepo$observed_growth, type="BAI",
                 cohort = "T14_148", temporalResolution = "year")
g3<-evaluation_plot(G_34m, alepo$observed_growth, type="BAI",
                 cohort = "T25_148", temporalResolution = "year")
g4<-evaluation_plot(G_34m, alepo$observed_growth, type="BAI",
                 cohort = "T3_148", temporalResolution = "year")
plot_grid(g1,g2,g3,g4, ncol = 2, nrow=2)
```
]

---

## Step 7. Reduce the number of tree cohorts

In order to speed-up calculations, we can reduce the number of tree cohorts, which is now:
.code80[
```{r}
nrow(alepo$forest_snfi3$treeData)
```
]

Remembering the `forest_mergeTrees()` function from exercise #1:

.code80[
```{r}
forest_red = forest_mergeTrees(alepo$forest_snfi3)
```
]

The new forest object only has `r nrow(forest_red$treeData)` tree cohorts:

.code80[
```{r}
forest_red$treeData
```
]

---
## Step 8. Run forest dynamics simulation

We use `forest_red` to call function `fordyn()`. Remember that, unlike `spwb()` and `growth()`, we do not need to build an intermediate input object.

We supply the historic weather (yrs. 2001-2014), as we did for `growth()`, because we want to compare the results with observed forest inventory data.

.code80[
```{r, eval = FALSE}
FD_34 <- fordyn(forest = forest_red,
                soil = alepo$soil,
                SpParams = SpParamsMED,
                control = defaultControl(),
                meteo = alepo$historic_weather,
                latitude = 41, 
                elevation = alepo$spt$elevation,
                slope = alepo$spt$slope,
                aspect = alepo$spt$aspect)
```
]


```{r, include = FALSE}
# saveRDS(FD_34, "Rdata/fordyn_snfi34.rds")
FD_34 <- readRDS("Rdata/fordyn_snfi34.rds")
```


The elements of the output have the following names, which we should be able to understand before moving on.
.code80[
```{r}
names(FD_34)
```
]


---

## Step 9. Compare final stand metrics with the observed stand in SNFI4

In particular, we can examine the stand metrics of the `forest` object at the end of the simulation
.code80[
```{r, highlight.output = c(2,5)}
summary(FD_34$NextForestObject, SpParamsMED)
```
]

and compare them to those obtained in SNFI4 (yr. 2015) for the forest plot:

.code80[
```{r, highlight.output = c(2,5)}
summary(alepo$forest_snfi4, SpParamsMED)
```
]

The model seems to perform fairly well in terms of final tree density and basal area. However, as expected, it yields too much shrub mortality, resulting in a forest with a low understory biomass.
---

## Step 10. Projection of forest dynamics


.code80[
```{r, eval = FALSE}
FD_proj <- fordyn(forest = FD_34,
                soil = alepo$soil,
                SpParams = SpParamsMED,
                control = defaultControl(),
                meteo = alepo$projected_weather,
                latitude = 41, 
                elevation = alepo$spt$elevation,
                slope = alepo$spt$slope,
                aspect = alepo$spt$aspect)
```
]


```{r, include = FALSE}
# saveRDS(FD_proj, "Rdata/fordyn_proj.rds")
FD_proj <- readRDS("Rdata/fordyn_proj.rds")
```

---

## Step 12. Management function and management arguments

.code80[
```{r}
man_args <- defaultManagementArguments()
names(man_args)
```
]

.code80[
```{r}
man_args$thinningThreshold <- 30
```
]

---

## Step 13. Projection of forest dynamics with management

.code80[
```{r, eval = FALSE}
FD_proj_man <- fordyn(forest = FD_34,
                soil = alepo$soil,
                SpParams = SpParamsMED,
                control = defaultControl(),
                meteo = alepo$projected_weather,
                latitude = 41, 
                elevation = alepo$spt$elevation,
                slope = alepo$spt$slope,
                aspect = alepo$spt$aspect,
                management_function = defaultManagementFunction,
                management_args = man_args
                )
```
]

```{r, include = FALSE}
# saveRDS(FD_proj_man, "Rdata/fordyn_proj_man.rds")
FD_proj_man <- readRDS("Rdata/fordyn_proj_man.rds")
```

---

## Step 14. Compare forest dynamics with/without management

.pull-left[
.code80[
### No management

```{r, fig = TRUE, fig.height = 4}
plot(FD_proj, "StandBasalArea")
```
]
]

.pull-left[
.code80[
### Management (thinning from below)

```{r, fig = TRUE, fig.height = 4}
plot(FD_proj_man, "StandBasalArea")
```
]
]

---

## Step 14. Compare forest dynamics with/without management

.pull-left[
.code80[
### No management

```{r, fig = TRUE, fig.height = 4}
FD_proj$NextForestObject$treeData[,1:4]
```

```{r}
sum(FD_proj$StandSummary$BasalAreaDead)
```

]
]

.pull-right[
.code80[
### Management (thinning from below)

```{r, fig = TRUE, fig.height = 4}
FD_proj_man$NextForestObject$treeData[,1:4]
```

```{r}
sum(FD_proj_man$StandSummary$BasalAreaDead)
```

```{r}
sum(FD_proj_man$StandSummary$BasalAreaCut)
```

]
]


---
layout: false
class: back-slide


## M.C. Escher - Concave and convex, 1955

.center[
<img src="resources/img/Escher_concaveconvex.jpg" width=600>
]

<img class="logo-title" src="resources/img/emf_logo.svg" width=200>
