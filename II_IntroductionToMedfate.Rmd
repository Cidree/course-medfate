---
title: "II - Introduction to medfate"
author: "Miquel De CÃ¡ceres (EMF)"
date: "23/2/2022"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
---

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(medfate)
library(medfateutils)
```

---
layout: true
### Purpose and development context

---
#### Model scope

Being able to anticipate the impact of global change on forest ecosystems is one of the major environmental challenges in contemporary societies. 

--

The R package `medfate` has been designed to study the characteristics and simulate the functioning and structural dynamics of forest ecosystems.

--

Climatic conditions are the main environmental drivers, with a particular focus on drought impacts under Mediterranean conditions. 

--

Representation of vegetation accounts for structural and compositional variation but is not spatially-explicit (i.e. trees or shrubs do not have explicit coordinates within forest stands). 

---
#### Development context


---
#### Companion packages

During the development of **medfate** some functions have been originally placed there and then moved to more specialized packages which now evolve in parallel to **medfate**:

--
  + Package [**meteoland**](https://github.com/emf-creaf/meteoland) allows generating daily weather input for simulation models.
--

  + Package [**medfateland**](https://github.com/emf-creaf/medfateland) extends **medfate** by allowing simulations to be performed in a spatially explicit context.
--

  + Package [**medfateutils**](https://github.com/emf-creaf/medfateutils) provides functions to help initializing vegetation, soil and species inputs.


---
layout: false
<!-- # Package installation -->

### Installation from CRAN or GitHub

From CRAN (stable versions):
```{r, eval = FALSE, include = TRUE, echo = TRUE}
install.packages("medfate")
```
--

From GitHub (frequent updates):
```{r, eval = FALSE, include = TRUE, echo = TRUE}
remotes::install_github("emf-creaf/medfate")
```

--

This session we will also use package **medfateutils**:
```{r, eval = FALSE, include = TRUE, echo = TRUE}
remotes::install_github("emf-creaf/medfateutils")
```


---
layout: true
### Overview of package functions

---
#### Simulation functions

Three main simulation models can be executed in medfate, each building on the preceeding ones.

|  Function | Description                 |
| --------- | --------------------------- |
| `spwb()` | Water and energy balance    |
| `growth()` | Carbon balance, growth and mortality |
| `fordyn()` | Forest dynamics, including recruitment and forest management |


---
#### Post-processing functions


---
#### Submodel functions

Sub-model functions are grouped by *subject*:

-   `biophysics_*`: Physical and biophysical utility functions.
-   `carbon_*`: Carbon balance.
-   `hydraulics_*`: Plant hydraulics.
-   `hydrology_*`: Canopy and soil hydrology.
-   `light_*`: Light extinction and absortion.
-   `moisture_*`: Live tissue moisture.
-   `pheno_*`: Leaf phenology.
-   `photo_*`: Leaf photosynthesis.
-   `root_*`: Root distribution and conductance calculations.
-   `soil_*`: Soil hydraulics and thermodynamics.
-   `transp_*`: Stomatal regulation, transpiration and photosynthesis.
-   `wind_*`: Canopy turbulence.

???
Notes here

---
layout: false
### Species parameter input

Simulation models in **medfate** require a `data.frame` with species parameter values.

--

The package includes a default data set of parameter values for a set of Mediterranean species.

```{r, echo = TRUE}
data("SpParamsMED")
```

--

A large number of parameters (columns) can be found in `SpParamsMED`. Not all parameters are needed for all models. You can find parameter definitions in table `SpParamsDefinition`:

```{r, echo = TRUE}
data("SpParamsDefinition")
```


---

layout:true
### Forest input

---

#### Forest object

Each forest plot is represented in an object of class `forest`, a list that contains several elements. 

```{r, include = TRUE, echo = TRUE}
forest <- exampleforestMED
```

--

The most important items are two data frames, `treeData` (for trees):
```{r, echo = TRUE}
forest$treeData
```

--

and `shrubData` (for shrubs):
```{r, echo = TRUE}
forest$shrubData
```

---
#### Creating a 'forest' object from forest inventory data


---

#### Forest attributes

The package includes a number of functions to examine properties of the plants conforming the `forest` object:

-   `plant_*`: Cohort-level information (species name, id, leaf area index, height...).
-   `species_*`: Species-level attributes (e.g. basal area, leaf area index).
-   `stand_*`: Stand-level attributes (e.g. basal area).

```{r, echo = TRUE}
plant_basalArea(forest)
```


```{r, echo = TRUE}
plant_LAI(forest, SpParamsMED)
```

---
#### Aboveground data

Simulation functions in `medfate` allow starting in a more general way using two data frames, one with **aboveground** information and the other with **belowground** information.

```{r, echo = TRUE}
above <- forest2aboveground(forest, SpParamsMED)
above
```

The call to `forest2aboveground()` includes species parameters because species-specific values are needed to calculate leaf area from tree diameters or shrub cover.

---
layout: true
### Vertical profiles

---

#### Leaf distribution

Aboveground leaf area distribution (at the cohort-, species- or stand-level) can be examined by calling function `vprofile_leafAreaDensity()`:

--
```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_leafAreaDensity(forest, SpParamsMED, byCohorts = TRUE)
```

---
#### Radiation extinction

Radiation extinction (PAR or SWR) profile across the vertical axis can also be examined:

```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_PARExtinction(forest, SpParamsMED)
```

---
#### Belowground root distribution

Users can visually inspect the distribution of fine roots of `forest` objects by calling function `vprofile_rootDistribution()`:

```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_rootDistribution(forest, SpParamsMED)
```

---
layout: false
### Interactive forest inspection

Function `shinyplot()` is a more convenient way to display properties and profiles of `forest` objects:

```{r, eval = FALSE, include = TRUE, echo = TRUE}
shinyplot(forest, SpParamsMED)
```



---
layout: true
### Soil input

---
#### Soil physical description

Soil physical attributes can be initialized to default values, for a given number of layers, using function `defaultSoilParams()`:

```{r, echo = TRUE}
spar <- defaultSoilParams(2)
print(spar)
```

---
#### Drawing soil physical attributes from *SoilGrids*


---
#### Soil input object

Soil input for simulations is an object of class `soil` (a list) that is created from physical description using a function with the same name:

```{r, echo = TRUE}
examplesoil <- soil(spar)
class(examplesoil)
```

---
#### Water retention curves

The **water retention curve** is used to represent the relationship between soil water content ( $\theta$ ; %) and soil water potential ( $\Psi$ ; MPa).

The following code calls function `soil_retentionCurvePlot()` to illustrate the difference between the two water retention models in this soil:

```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
soil_retentionCurvePlot(examplesoil, model="both")
```


---
layout: false
### Weather input

All simulations in the package require **daily weather** inputs in form of a `data.frame` with dates as `row.names`. 

--

An example of daily weather data frame: 
```{r, echo = TRUE}
data(examplemeteo)
head(examplemeteo, 2)
```

--

The weather variables that are required depend on the complexity of model we are using. Simulation functions have been designed to accept data frames generated using package [meteoland](https://emf-creaf.github.io/meteoland/). 


---
### Simulation control
The behaviour of simulation models can be controlled using a set of global parameters. 

The default parameterization is obtained using function `defaultControl()`:

```{r, echo = TRUE}
control <- defaultControl()
```

A large number of control parameters exist:

```{r, echo = TRUE, eval = FALSE, include=TRUE}
names(control)
```


Control parameters should normally be left to their **default values** until their effect on simulations is fully understood.

---
### Simulation input object

Simulation functions `spwb()` and `growth()` require combining forest, soil, species-parameter and simulation control inputs into a **single input object** that is then passed to the corresponding simulation function along with weather data. 

--

The combination of inputs is done via functions `spwbInput()` and `growthInput()`, respectively, or the more convenient `forest2spwbInput()` and `forest2growthInput()`:

```{r, echo = TRUE}
x <- forest2spwbInput(forest, examplesoil, SpParamsMED, control)
```

--
Having this additional step is handy because initialized cohort-level parameters and state variables can then be modified before calling the actual simulation functions.

--

Function `fordyn()` is different from the other two models: the user enters forest, soil, weather, species parameters and simulation control inputs directly into the simulation function.