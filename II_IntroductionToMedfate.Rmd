---
title: "II - Introduction to medfate"
author: "Miquel De Cáceres (EMF)"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
---

```{r setup, include=FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE)
```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#1381B0",
  secondary_color = "#FF961C",
  inverse_header_color = "#FFFFFF"
)
```

```{r, include = FALSE}
library(medfate)
library(sp)
```


background-image: url(isotip-fons.png)

### Outline

  1. Purpose and development context
  2. Package installation
  3. Overview of package functions
  4. Species parameters
  5. Forest input
  6. Vertical profiles
  7. Soil input
  8. Weather input
  9. Simulation control
  10. Simulation input object
  

---
layout: true
### 1. Purpose and development context

---
#### Model scope

Being able to anticipate the impact of global change on forest ecosystems is one of the major environmental challenges in contemporary societies. 

--

The R package **medfate** (ver. `r utils::packageDescription("medfate",fields="Version")`) has been designed to study the characteristics and simulate the functioning and structural dynamics of forest ecosystems.

--

Climatic conditions are the main environmental drivers, with a particular focus on drought impacts under Mediterranean conditions. 

--

Representation of vegetation accounts for structural and compositional variation but is not spatially-explicit (i.e. trees or shrubs do not have explicit coordinates within forest stands). 

---
#### Development context

I have been intensively working on medfate since 2013, when I obtained a Ramon y Cajal research fellowship from the Spanish government. Two other competitive research projects have funded developments.

--

Developments were also supported by CTFC, the research institution until March 2021, and CREAF, my current institution where I coordinate its *Ecosystem Modelling Facility*.

--

A large number of people has contributed with *ideas*, *data* or *code* to the project:

.pull-left[

+ Jordi Martínez-Vilalta (CREAF-UAB, Spain)
+ Maurizio Mencuccini (CREAF-ICREA, Spain)
+ Juli G. Pausas (CIDE-CSIC, Spain)
+ Pilar Llorens (CSIC, Spain)
+ Rafa Poyatos (CREAF, Spain)
+ Lluís Brotons (CREAF-CSIC, Spain)
+ Antoine Cabon (WSL, Switzerland)
+ Roberto Molowny (EMF-CREAF, Spain)

]
.pull-right[

+ Victor Granda (EMF-CREAF, Spain)
+ Lluís Coll (UdL, Spain)
+ Pere Casals (CTFC, Spain)
+ Mario Beltrán (CTFC, Spain)
+ Aitor Améztegui (UdL, Spain)
+ Nicolas Martin-StPaul (INRA, France)
+ Shengli Huang (USDA, USA)
+ Enric Batllori (UB-CREAF, Spain)

]

---

#### Companion packages

During the development of **medfate** ancillary functions were also originally included in the package itself. 

--

Many of them were later moved into more specialized packages, which now evolve in parallel to the main package:

--
1. Package [**meteoland**](https://github.com/emf-creaf/meteoland) (ver. `r utils::packageDescription("meteoland",fields="Version")`) allows generating daily weather input for simulation models.

--

2. Package [**medfateland**](https://github.com/emf-creaf/medfateland)  (ver. `r utils::packageDescription("medfateland",fields="Version")`) extends **medfate** by allowing simulations to be performed in a spatially explicit context.

--

3. Package [**medfateutils**](https://github.com/emf-creaf/medfateutils)  (ver. `r utils::packageDescription("medfateutils",fields="Version")`) provides functions to help initializing vegetation, soil and species inputs.


---
layout: false

### 2. Package installation

From **CRAN** (stable versions):
```{r, eval = FALSE, include = TRUE, echo = TRUE}
install.packages("medfate")
```
--

From **GitHub** (frequent updates):
```{r, eval = FALSE, include = TRUE, echo = TRUE}
remotes::install_github("emf-creaf/medfate")
```

--

This session we will also use package **medfateutils**:
```{r, eval = FALSE, include = TRUE, echo = TRUE}
remotes::install_github("emf-creaf/medfateutils")
```

--
We load these and additional packages needed for the session:
```{r}
library(medfate)
library(medfateutils)
```


---
layout: true
### 3. Overview of package functions

---
#### Simulation functions

Three main simulation models can be executed in medfate, each building on the preceeding ones.

|  Function | Description                 |
| --------- | --------------------------- |
| `spwb()` | Water and energy balance    |
| `growth()` | Carbon balance, growth and mortality |
| `fordyn()` | Forest dynamics, including recruitment and forest management |

--

#### Plot/summary functions

Specific `summary()` and `plot()` functions are included to *extract* and *display* the time series included in the output of each simulation function. 

---
#### Post-processing functions

Some package functions are meant to be used on simulation results (some of them implementing static ancillary models) and produce time series of additional properties.


--

|  Function | Description                 |
| --------- | --------------------------- |
| `droughtStress()` | Plant drought stress indices    |
| `waterUseEfficiency()` | Water use efficiency metrics    |
| `resistances()` | Hydraulic resistances to water transport    |
| `moisture_cohortFMC()` | Fuel moisture content    |
| `fireHazard()` | Potential fire behaviour   |


---
layout: true
### 3. Overview of package functions
#### Sub-model functions

A large number of functions implement sub-models on which the simulation functions are built. They are included in the package for the sake of transparency, but most users are not expected to use them directly. 

Sub-model functions are grouped by *subject*:

---

|  Group    | Description                 |
| --------- | --------------------------- |
|  `biophysics_*` | Physics and biophysics |
|  `carbon_*` | Carbon balance |
|  `fuel_*`  | Fuel properties |
|  `fire_*`  | Fire behaviour |
|  `hydraulics_*` | Plant hydraulics |
|  `hydrology_*` | Canopy and soil hydrology |

---

|  Group    | Description                 |
| --------- | --------------------------- |
|  `light_*` | Light extinction and absortion |
|  `moisture_*` | Live tissue moisture  |
|  `pheno_*` | Leaf phenology  |
|  `photo_*` | Leaf photosynthesis  |
|  `root_*` | Root distribution and conductance calculations  |
|  `soil_*` | Soil hydraulics and thermodynamics  |
|  `transp_*` | Stomatal regulation, transpiration and photosynthesis  |
|  `wind_*` | Canopy turbulence |

???
Notes here

---
layout: false
### 4. Species parameters

Simulation models in **medfate** require a `data.frame` with species parameter values.

--

The package includes a default data set of parameter values for a set of Mediterranean species.

```{r, echo = TRUE}
data("SpParamsMED")
```

--

A large number of parameters (columns) can be found in `SpParamsMED`. Not all parameters are needed for all models. You can find parameter definitions in table `SpParamsDefinition`:

```{r, echo = TRUE}
data("SpParamsDefinition")
```


---

layout:true
### 5. Forest input

---

#### Forest object

Each forest plot is represented in an object of class `forest`, a list that contains several elements. 

```{r, include = TRUE, echo = TRUE}
forest <- exampleforestMED
```

--

The most important items are two data frames, `treeData` (for trees):
```{r, echo = TRUE}
forest$treeData
```

--

and `shrubData` (for shrubs):
```{r, echo = TRUE}
forest$shrubData
```

---
#### Creating a 'forest' object from forest inventory data


---

#### Forest attributes

The package includes a number of functions to examine properties of the plants conforming the `forest` object:

-   `plant_*`: Cohort-level information (species name, id, leaf area index, height...).
-   `species_*`: Species-level attributes (e.g. basal area, leaf area index).
-   `stand_*`: Stand-level attributes (e.g. basal area).

```{r, echo = TRUE}
plant_basalArea(forest)
```


```{r, echo = TRUE}
plant_LAI(forest, SpParamsMED)
```

---
#### Aboveground data

An important information for simulation model is the estimation of initial leaf area index and crown dimensions for each plant cohort, which is normally done using *allometries*.

--

We can illustrate this step using function `forest2aboveground()`:

```{r, echo = TRUE}
above <- forest2aboveground(forest, SpParamsMED)
above
```

where species-specific allometric coefficients are taken from `SpParamsMED`.

--

Users will not normally call `forest2aboveground()`, but is important to understand what is going on behind the scenes.

---
layout: true
### 6. Vertical profiles

---

#### Leaf distribution

Vertical leaf area distribution (at the cohort-, species- or stand-level) can be examined using:

.pull-left[
```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_leafAreaDensity(forest, SpParamsMED, 
                         byCohorts = FALSE)
```
]

.pull-right[
```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_leafAreaDensity(forest, SpParamsMED, 
                         byCohorts = TRUE)
```
]
---
#### Radiation extinction

Radiation extinction (PAR or SWR) profile across the vertical axis can also be examined:

.pull-left[
```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_PARExtinction(forest, SpParamsMED)
```
]
.pull-right[
```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_SWRExtinction(forest, SpParamsMED)
```
]

---
#### Belowground root distribution

Users can visually inspect the distribution of fine roots of `forest` objects by calling function `vprofile_rootDistribution()`:

```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
vprofile_rootDistribution(forest, SpParamsMED)
```

---
#### Interactive forest inspection

Function `shinyplot()` is a more convenient way to display properties and profiles of `forest` objects:

```{r, eval = FALSE, include = TRUE, echo = TRUE}
shinyplot(forest, SpParamsMED)
```



---
layout: true
### 7. Soil input

---
#### Soil physical description

Soil physical attributes can be initialized to default values, for a given number of layers, using function `defaultSoilParams()`:

```{r, echo = TRUE}
spar <- defaultSoilParams(2)
print(spar)
```

---
#### Drawing soil physical attributes from *SoilGrids*

*SoilGrids* is a global database of soil properties:

.center[
*Hengl T, Mendes de Jesus J, Heuvelink GBM, Ruiperez Gonzalez M, Kilibarda M, Blagotić A, et al. (2017) SoilGrids250m: Global gridded soil information based on machine learning. PLoS ONE 12(2): e0169748. doi:10.1371/journal.pone.0169748.*
]

--

Package **medfateutils** allows retrieving Soilgrids data by connecting with the SoilGrids [REST API](https://rest.isric.org)

--

To start with, we need an object of class `SpatialPoints` (from package **sp**) containing the geographic coordinates of our target forest stand:

```{r}
cc <- matrix(c(1.32, 42.20), nrow=1)
sp <- SpatialPoints(cc, proj4string = CRS(SRS_string = "EPSG:4326"))
```

--

We then call `soilgridsParams()` along with a desired vertical width of soil layers:

```{r, eval = FALSE}
soilgridsParams(sp, widths = c(300, 700, 1000))
```


---
#### Soil input object

Soil input for simulations is an object of class `soil` (a list) that is created from physical description using a function with the same name:

```{r, echo = TRUE}
examplesoil <- soil(spar)
class(examplesoil)
```

---
#### Water retention curves

The **water retention curve** is used to represent the relationship between soil water content ( $\theta$ ; %) and soil water potential ( $\Psi$ ; MPa).

The following code calls function `soil_retentionCurvePlot()` to illustrate the difference between the two water retention models in this soil:

```{r, fig = TRUE, fig.width= 6, fig.height=4, fig.align= 'center', echo=TRUE}
soil_retentionCurvePlot(examplesoil, model="both")
```


---
layout: false
### 8. Weather input

All simulations in the package require **daily weather** inputs in form of a `data.frame` with dates as `row.names`. 

--

An example of daily weather data frame: 
```{r, echo = TRUE}
data(examplemeteo)
head(examplemeteo, 2)
```

--

The weather variables that are required depend on the complexity of model we are using. Simulation functions have been designed to accept data frames generated using package [meteoland](https://emf-creaf.github.io/meteoland/). 


---
### 9. Simulation control
The behaviour of simulation models can be controlled using a set of global parameters. 

The default parameterization is obtained using function `defaultControl()`:

```{r, echo = TRUE}
control <- defaultControl()
```

A large number of control parameters exist:

```{r, echo = TRUE, eval = FALSE, include=TRUE}
names(control)
```


Control parameters should normally be left to their **default values** until their effect on simulations is fully understood.

---
### 10. Simulation input object

Simulation functions `spwb()` and `growth()` require combining forest, soil, species-parameter and simulation control inputs into a **single input object** that is then passed to the corresponding simulation function along with weather data. 

--

The combination of inputs is done via functions `spwbInput()` and `growthInput()`, respectively, or the more convenient `forest2spwbInput()` and `forest2growthInput()`:

```{r, echo = TRUE}
x <- forest2spwbInput(forest, examplesoil, SpParamsMED, control)
```

--
Having this additional step is handy because initialized cohort-level parameters and state variables can then be modified before calling the actual simulation functions.

--

Function `fordyn()` is different from the other two models: the user enters forest, soil, weather, species parameters and simulation control inputs directly into the simulation function.



---
class: center, middle

# Thanks!

Slides created via the R packages:

[**xaringan**](https://github.com/yihui/xaringan)<br>
[gadenbuie/xaringanthemer](https://github.com/gadenbuie/xaringanthemer)

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr), and [R Markdown](https://rmarkdown.rstudio.com).