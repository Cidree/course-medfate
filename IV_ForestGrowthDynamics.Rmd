---
title: "IV - Forest growth and dynamics"
author: 
  - "Miquel De CÃ¡ceres (EMF)"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
---


```{r setup, include=FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include = FALSE}
library(medfate)
library(cowplot)
```


```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#1381B0",
  secondary_color = "#FF961C",
  inverse_header_color = "#FFFFFF"
)
```



background-image: url(isotip-fons.png)

### Outline

  1. Forest growth inputs
  2. Running forest growth
  3. Evaluation of growth predictions
  4. Running forest dynamics

  
---
layout: true
### 1. Forest growth inputs

---

#### Creating the forest growth input object

We assume we have an appropriate forest object and species parameter data frame:
```{r, echo = TRUE}
data(exampleforestMED)
data(SpParamsMED)
```

--

a soil input object:
```{r, echo = TRUE}
examplesoil <- soil(defaultSoilParams(4))
```

--
and simulation control list (the complexity of the water balance can be changed by using `"Sperry"`):
```{r, echo = TRUE}
control <- defaultControl("Granier")
```

--

With these four elements we can build our input object for function `growth()`:
```{r, echo = TRUE}
x <- forest2growthInput(exampleforestMED, examplesoil, SpParamsMED, control)
```

---
layout: true
### 1. Forest growth inputs
#### Structure of the growth input object

---

The water balance input object is a `list` with several elements:
```{r, echo = TRUE}
names(x)
```

---

Element `above` contains the above-ground structure data that we already know, but with an additional columns that describes the estimated initial amount of *sapwood area*:
```{r}
x$above
```

---

Elements starting with `params*` contain cohort-specific model parameters.  An important set of parameters are in `paramsGrowth`:
```{r}
x$paramsGrowth
```

---

Elements starting with `internal*` contain state variables required to keep track of plant status. For example, the metabolic and storage carbon levels can be seen in `internalCarbon`:
```{r}
x$internalCarbon
```

---
layout: true
###  2. Running forest growth
#### Forest growth run

---

The call to function `growth()` needs the growth input object, the weather data frame, latitude and elevation:

```{r, echo = TRUE, eval = FALSE}
G <- growth(x, examplemeteo, latitude = 41.82592, elevation = 100)
```
```{r, include = FALSE, eval = TRUE}
G <- growth(x, examplemeteo, latitude = 41.82592, elevation = 100)
```

--

Function `growth()` returns an object of class with the same name, actually a list:
```{r, echo = TRUE}
class(G)
```

---

... whose elements are:

```{r, echo = TRUE}
names(G)
```

--

Some elements of the list are common with the output of `spwb()`. In particular, `growthInput` contains a copy of the input object, whereas `growthOutput` contains the same object, but with values of state variables at the end of simulation.

--

New list elements, with respect to`spwb()`, are `LabileCarbonBalance` (components of the labile carbon balance), `PlantBiomassBalance` (plant- and cohort-level biomass balance), `PlantStructure` (daily series of structural variables) and `GrowthMortality` (daily growth and mortality rates).

---
layout: true
###  2. Running forest growth

---

#### Plots and summaries

Users can inspect the output of `growth()` simulations using functions `summary()` and `plot()` on the simulation output. 

--

Several new plots are available in addition to those available for `spwb()` simulations. 

--

For example, one can display maintenance respiration costs:

```{r, eval = FALSE, echo=TRUE}
plot(G, "MaintenanceRespiration", bySpecies = T)
```

--

... but instead of typing all plots, we can call the interactive plot function and explore them all:

```{r, eval = FALSE, include = TRUE, echo = TRUE}
shinyplot(G)
```


---
layout: true
### 3. Evaluating model performance

---

Evaluation of growth simulations will normally imply the comparison of predicted vs observed basal area increment (BAI) or diameter increment at a given temporal resolution. 

Here, we illustrate the evaluation functions included in the package using a fake data set, consisting on the predicted values and some added error.
```{r}
data(exampleobs)
```

Normally growth evaluations will be at annual scale, but here we only have one year of simulated growth. 

---

Assuming we want to evaluate the predictive capacity of the model in terms of monthly basal area increment for the pine cohort, we can plot the relationship between observed and predicted values using function `evaluation_plot()`:

```{r, fig=TRUE, echo=TRUE, fig.align='center', fig.width=4, fig.height=4}
evaluation_plot(G, exampleobs, "BAI", cohort = "T1_148", 
                temporalResolution = "month", plotType = "scatter")
```

---

... and the following code would help us quantifying the strength of the relationship:

```{r}
evaluation_stats(G, exampleobs, "BAI", cohort = "T1_148", 
                 temporalResolution = "month")
```

---
layout: true
###  4. Running forest dynamics

---

#### Preparing model inputs
adsfsd

In this vignette we will fake a three-year weather input by repeating the example weather data frame three times.
```{r}
meteo = rbind(examplemeteo, examplemeteo, examplemeteo)
row.names(meteo) = seq(as.Date("2001-01-01"), 
                       as.Date("2003-12-31"), by="day")
```

Importantly, `fordyn()` operates on `forest` objects directly, instead of using an intermediary object (such as `spwbInput` and `growthInput`).
 
---

#### Executing function `fordyn()`

Now we run the forest dynamics model using:

```{r}
fd<-fordyn(exampleforestMED, examplesoil, SpParamsMED, meteo, control, 
           latitude = 41.82592, elevation = 100)
```

It is important to know that `fordyn()` calls function `growth()` internally for each simulated year (the `verbose` option of the control parameters only affects function `fordyn()`, i.e. all console output from `growth()` is hidden). 

--

As with other models, the output of `fordyn()` is a list, which has the following elements:
```{r}
names(fd)
```

---
layout: true
###  4. Running forest dynamics
#### Summaries and plots

---

Among other outputs, function `fordyn()` calculates standard summary statistics that describe the structural and compositional state of the forest at each time step. For example, we can access stand-level statistics using:

```{r, eval = FALSE}
fd$StandSummary
```

--

Species-level analogous statistics are shown using:
```{r, eval = FALSE}
fd$SpeciesSummary
```

--

Package `medfate` also provides a `plot` function for objects of class `fordyn`. For example, we can show the year-to-year variation in stand-level basal area using:

```{r, eval = FALSE}
plot(fd, type = "StandBasalArea")
```

---

Another useful output of `fordyn()` are tables in long format with cohort structural information (i.e. DBH, height, density, etc) for each time step:

```{r}
fd$TreeTable
```

The same can be shown for dead trees:
```{r, eval = FALSE}
fd$DeadTreeTable
```

---

Function `fordyn()` makes internal calls to function `growth()` and stores the result in a vector called `GrowthResults`. 

--

Accessing this element, we can summarize or plot simulation results for a particular year. For example, the following shows the leaf area for individuals of the three cohorts during the second year:

```{r, eval = FALSE}
plot(fd$GrowthResults[[2]], "LeafArea", bySpecies = T)
```

--

Instead of examining year by year, it is possible to plot the whole series of results by passing a `fordyn` object to the `plot()` function:

```{r, eval = FALSE}
plot(fd, "LeafArea")
```

--

Finally, we can create interactive plots using function `shinyplot()`:
```{r, eval = FALSE}
shinyplot(fd)
```

  
---
layout: false
class: center, middle

# Thanks!

Slides created via the R packages:

[**xaringan**](https://github.com/yihui/xaringan)<br>
[gadenbuie/xaringanthemer](https://github.com/gadenbuie/xaringanthemer)

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr), and [R Markdown](https://rmarkdown.rstudio.com).
